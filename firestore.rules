rules_version = '2';

// PRODUCTION SECURITY RULES FOR FLUTTERORBIT ACADEMY
// Copy these rules to: https://console.firebase.google.com/project/flutterkit-a8bc8/firestore/rules
// Then click "Publish"

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check rate limiting (basic)
    function isValidEmail(email) {
      return email is string 
             && email.size() > 5 
             && email.size() < 256
             && email.matches('.*@.*\\..*');
    }
    
    function isValidString(str, maxLen) {
      return str is string && str.size() > 0 && str.size() < maxLen;
    }
    
    // Newsletter collection - allow anyone to subscribe
    match /newsletter/{document} {
      // Only allow creating with valid email format
      allow create: if isValidEmail(request.resource.data.email)
                    && request.resource.data.keys().hasOnly(['email', 'subscribedAt', 'active']);
      // Allow read to check if email exists (needed for duplicate check)
      allow read: if true;
      // No updates or deletes from client
      allow update, delete: if false;
    }
    
    // Feedback collection - allow anyone to submit feedback
    match /feedback/{document} {
      // Validate feedback structure
      allow create: if isValidString(request.resource.data.message, 5000)
                    && request.resource.data.type in ['suggestion', 'bug', 'content', 'appreciation']
                    && request.resource.data.keys().hasOnly(['type', 'message', 'email', 'userAgent', 'url', 'submittedAt', 'status']);
      // Feedback is private - no read from client
      allow read, update, delete: if false;
    }
    
    // Community stats - limited access
    match /stats/{document} {
      allow read: if true;
      // Only allow incrementing specific numeric fields
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
                      .hasOnly(['totalLearners', 'modulesCompleted', 'hoursLearned', 'averageStreak']);
      // Allow initial creation only for 'community' document
      allow create: if document == 'community';
      allow delete: if false;
    }
    
    // Shared progress - public sharing
    match /sharedProgress/{document} {
      // Validate progress data structure
      allow create: if request.resource.data.percentComplete is number
                    && request.resource.data.percentComplete >= 0
                    && request.resource.data.percentComplete <= 100
                    && request.resource.data.keys().hasOnly(['completedModules', 'completedTopics', 'streak', 'percentComplete', 'sharedAt', 'views']);
      allow read: if true;
      // Only allow incrementing views
      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views'])
                    && request.resource.data.views == resource.data.views + 1;
      allow delete: if false;
    }
    
    // Leaderboard - public but validated
    match /leaderboard/{document} {
      allow create: if isValidString(request.resource.data.name, 100)
                    && request.resource.data.score is number
                    && request.resource.data.score >= 0
                    && request.resource.data.score <= 100000;
      allow read: if true;
      allow update, delete: if false;
    }
    
    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
